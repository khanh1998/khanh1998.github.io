<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Postgres Advisory Locks | Khanh1998</title>
<meta name=keywords content="db,postgres-for-everything"><meta name=description content="This post is part of the series Postgres for Everything.
Nowadays, we typically develop stateless applications, making it easier to scale them horizontally. However, locking is an essential tool to prevent race conditions in software development. In applications with multiple instances, programming language-level locks are insufficient because they only work locally within an instance. A centralized locking mechanism, valid across all instances, is required.
Redis
SETNX
You can use SETNX to implement a simple lock. SETNX sets a value for a key only if the key does not already exist."><meta name=author content="Khanh Bui"><link rel=canonical href=https://khanh1998.github.io/posts/postgres-advisory-locks/><meta name=google-site-verification content="Siuz-KNzTaGnjWViVxoA0J6xLTJQtxwpsh9L7HHMNnA"><meta name=yandex-verification content="XYZabc"><meta name=msvalidate.01 content="XYZabc"><link crossorigin=anonymous href=/assets/css/stylesheet.fc220c15db4aef0318bbf30adc45d33d4d7c88deff3238b23eb255afdc472ca6.css integrity="sha256-/CIMFdtK7wMYu/MK3EXTPU18iN7/MjiyPrJVr9xHLKY=" rel="preload stylesheet" as=style><link rel=icon href=https://khanh1998.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://khanh1998.github.io/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=32x32 href=https://khanh1998.github.io/%3Clink%20/%20abs%20url%3E><link rel=apple-touch-icon href=https://khanh1998.github.io/%3Clink%20/%20abs%20url%3E><link rel=mask-icon href=https://khanh1998.github.io/%3Clink%20/%20abs%20url%3E><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://khanh1998.github.io/posts/postgres-advisory-locks/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script async src="https://www.googletagmanager.com/gtag/js?id=G-Y0MCHJNHTB"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-Y0MCHJNHTB")}</script><meta property="og:title" content="Postgres Advisory Locks"><meta property="og:description" content="This post is part of the series Postgres for Everything.
Nowadays, we typically develop stateless applications, making it easier to scale them horizontally. However, locking is an essential tool to prevent race conditions in software development. In applications with multiple instances, programming language-level locks are insufficient because they only work locally within an instance. A centralized locking mechanism, valid across all instances, is required.
Redis
SETNX
You can use SETNX to implement a simple lock. SETNX sets a value for a key only if the key does not already exist."><meta property="og:type" content="article"><meta property="og:url" content="https://khanh1998.github.io/posts/postgres-advisory-locks/"><meta property="og:image" content="https://khanh1998.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta property="article:section" content="posts"><meta property="article:published_time" content="2025-01-20T11:56:55+07:00"><meta property="article:modified_time" content="2025-01-20T11:56:55+07:00"><meta property="og:site_name" content="Khanh1998"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://khanh1998.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:title content="Postgres Advisory Locks"><meta name=twitter:description content="This post is part of the series Postgres for Everything.
Nowadays, we typically develop stateless applications, making it easier to scale them horizontally. However, locking is an essential tool to prevent race conditions in software development. In applications with multiple instances, programming language-level locks are insufficient because they only work locally within an instance. A centralized locking mechanism, valid across all instances, is required.
Redis
SETNX
You can use SETNX to implement a simple lock. SETNX sets a value for a key only if the key does not already exist."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://khanh1998.github.io/posts/"},{"@type":"ListItem","position":2,"name":"Postgres Advisory Locks","item":"https://khanh1998.github.io/posts/postgres-advisory-locks/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Postgres Advisory Locks","name":"Postgres Advisory Locks","description":"This post is part of the series Postgres for Everything.\nNowadays, we typically develop stateless applications, making it easier to scale them horizontally. However, locking is an essential tool to prevent race conditions in software development. In applications with multiple instances, programming language-level locks are insufficient because they only work locally within an instance. A centralized locking mechanism, valid across all instances, is required.\nRedis SETNX You can use SETNX to implement a simple lock. SETNX sets a value for a key only if the key does not already exist.\n","keywords":["db","postgres-for-everything"],"articleBody":"This post is part of the series Postgres for Everything.\nNowadays, we typically develop stateless applications, making it easier to scale them horizontally. However, locking is an essential tool to prevent race conditions in software development. In applications with multiple instances, programming language-level locks are insufficient because they only work locally within an instance. A centralized locking mechanism, valid across all instances, is required.\nRedis SETNX You can use SETNX to implement a simple lock. SETNX sets a value for a key only if the key does not already exist.\nThe key acts as the lock. Initially, it does not exist, so the fastest client can acquire it by setting a value. Other clients must wait until the key no longer exists to acquire the lock. Once the job is complete, the client releases the lock by deleting the key, giving other clients a chance to acquire it.\n1 SETNX key value SETNX does not allow setting an expiration time atomically when the key is created. Adding an expiration time is crucial to mitigate deadlocks and prevent crashed clients from holding locks indefinitely. You can achieve this using SET:\n1 SET key value NX EX 10 This approach works well when your Redis deployment consists of a single master node. However, issues arise in a master-replica setup. If the master crashes before a key is replicated to its replicas, the promoted replica might allow a new client to SETNX on the same key, resulting in two clients holding the same lock.\nRedlock To overcome the limitations of SETNX, Redis offers Redlock. Redlock works on multi-master clusters, improving the availability of the locking mechanism.\nIn a cluster with N nodes, Redlock requires locking N/2 + 1 nodes, tolerating up to N/2 - 1 node failures. For example, in a 5-node cluster, Redlock remains functional even if 2 nodes fail.\nHowever, Redlock is not guaranteed to be safe in all scenarios, as discussed in Martin Kleppmann’s blog. Therefore, Redlock might not be suitable for critical systems like banking or financial applications.\nPostgres Redis locks are convenient but may lack the safety required for critical tasks. If you already use Postgres in your project, it can be a great choice for centralized locking.\n1 2 3 4 5 CREATE TABLE user_balance ( name TEXT PRIMARY KEY, -- Name of the user, serves as the primary key balance NUMERIC(15, 2) NOT NULL DEFAULT 0.00 -- Balance with two decimal places ); INSERT INTO user_balance (name, balance) VALUES ('Alice', 100), ('Bob', 200); Row-Level Locks Using the SELECT ... FOR UPDATE syntax, you can acquire an exclusive lock on rows. These locks are automatically released at the end of the transaction. This mechanism is often combined with transactions for atomic updates.\nFor more details, see PostgreSQL Row-Level Locks.\nDemonstration Time Transaction 1 Transaction 2 1.0 BEGIN; 2.0 BEGIN; 3.0 SELECT balance FROM user_balance WHERE name = 'Alice' FOR UPDATE; 3.1 Alice’s balance = 100 4.0 SELECT balance FROM user_balance WHERE name = 'Alice' FOR UPDATE; 4.1 Blocked (Alice’s row is locked by TX1) 5.0 SELECT balance FROM user_balance WHERE name = 'Bob' FOR UPDATE; 5.1 Bob’s balance = 200 6.0 UPDATE user_balance SET balance = balance - 100 WHERE name = 'Alice'; 7.0 UPDATE user_balance SET balance = balance + 100 WHERE name = 'Bob'; 8.0 COMMIT; 9.0 Alice’s balance = 0 10.0 Continue Deadlock Example Deadlocks can occur when transactions acquire locks in an inconsistent order. For instance:\nTime Transaction 1 Transaction 2 1.0 BEGIN; 2.0 BEGIN; 3.0 SELECT balance FROM user_balance WHERE name = 'Alice' FOR UPDATE; 4.0 SELECT balance FROM user_balance WHERE name = 'Bob' FOR UPDATE; 5.0 SELECT balance FROM user_balance WHERE name = 'Bob' FOR UPDATE; Blocked 6.0 SELECT balance FROM user_balance WHERE name = 'Alice' FOR UPDATE; 7.0 Deadlock Deadlock To avoid deadlocks, acquire locks in a deterministic order (e.g., by ascending username).\nOptimistic Locking Optimistic locking assumes no concurrent modifications. It checks data integrity at the end of the transaction, rejecting changes if data has been altered. This approach is implemented using a version column, incremented on updates.\nSuccessful Scenario Time Transaction 1 Transaction 2 1.0 BEGIN; 2.0 BEGIN; 3.0 SELECT balance, version FROM user_balance WHERE name = 'Alice'; 5.0 UPDATE user_balance SET balance = balance - 100, version = version + 1 WHERE name = 'Alice' AND version = 0; 7.0 COMMIT; Failure Scenario Time Transaction 1 Transaction 2 1.0 BEGIN; 5.0 UPDATE user_balance SET balance = balance - 100, version = version + 1 WHERE name = 'Alice' AND version = 0; 6.0 UPDATE user_balance SET balance = 100, version = version + 1 WHERE name = 'Bob'; 7.0 Update failed (version mismatch) 8.0 ROLLBACK; Optimistic locking can also be implemented without a version column by validating data directly in the UPDATE query:\n1 UPDATE user_balance SET name = 'Alice Watson' WHERE id = 123 AND name = 'Alice'; Advisory Locks Row-level locks in PostgreSQL are useful, but what if the resource you need to lock doesn’t correspond to a database row? PostgreSQL provides an alternative: advisory locks. These locks are application-defined and can operate independently of the database schema. Advisory locks can be acquired at two levels: transaction and session.\nTransaction-Level Locks Exclusive Locks:\nYou can acquire an exclusive lock at the transaction level using the pg_advisory_xact_lock function. This is a blocking function, meaning that if another transaction already holds the lock, the current transaction will wait until the lock becomes available:\n1 2 3 BEGIN; SELECT pg_advisory_xact_lock(123); COMMIT; For a non-blocking version, use pg_try_advisory_xact_lock. It returns TRUE if the lock is acquired and FALSE otherwise.\nShared Locks:\nThe pg_advisory_xact_lock function provides exclusive locks, allowing only one transaction to hold the lock at a time. For shared access, use pg_advisory_xact_lock_shared. This allows multiple transactions to hold the lock simultaneously, making it suitable for read-only tasks. However, while shared locks are held, no exclusive lock can be acquired on the same key.\nTime Transaction 1 Transaction 2 1 BEGIN; 2 BEGIN; 3 Acquire shared lock: select pg_advisory_xact_lock_shared(123); 4 Try to acquire exclusive lock: select pg_advisory_xact_lock(123); 4.1 Get blocked 5 commit;: shared lock released Exclusive lock acquired after release Lock Release:\nAll transaction-level advisory locks are automatically released when the transaction ends, whether through COMMIT or ROLLBACK.\nLocking Costs:\nAdvisory locks are lightweight and impose less overhead compared to row-level locks. For example:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 postgres=# explain analyze select pg_advisory_lock(123); QUERY PLAN ------------------------------------------------------------------------------------ Result (cost=0.00..0.01 rows=1 width=4) (actual time=0.010..0.012 rows=1 loops=1) Planning Time: 0.111 ms Execution Time: 0.046 ms (3 rows) postgres=# explain analyze select * from user_balance where name = 'Alice' for update; QUERY PLAN --------------------------------------------------------------------------------------------------------------------------------------- LockRows (cost=0.15..8.18 rows=1 width=60) (actual time=0.201..0.207 rows=1 loops=1) -\u003e Index Scan using user_balance_pkey on user_balance (cost=0.15..8.17 rows=1 width=60) (actual time=0.061..0.066 rows=1 loops=1) Index Cond: (name = 'Alice'::text) Planning Time: 0.218 ms Execution Time: 0.258 ms (5 rows) Handling Non-Integer Keys Advisory locks only accept integer keys. To lock on a string key, hash it into an integer first:\n1 SELECT pg_advisory_xact_lock(hashtext('my_unique_lock')); Session-Level Locks Session-level locks persist across multiple transactions until explicitly released or the session ends. They are less commonly used but can be explored further in the PostgreSQL documentation.\nMonitoring Locks To view active advisory locks, query the pg_locks system catalog:\n1 SELECT * FROM pg_locks WHERE locktype = 'advisory'; Conclusion If Postgres is part of your tech stack, it’s an excellent choice for centralized locking, offering robust transaction management. Redis SETNX is fast but limited to single-node deployments. Redis Redlock provides high availability but lacks safety for critical applications. For highly available and safe distributed locking, consider Etcd, Consul, or ZooKeeper.\n","wordCount":"1277","inLanguage":"en","image":"https://khanh1998.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E","datePublished":"2025-01-20T11:56:55+07:00","dateModified":"2025-01-20T11:56:55+07:00","author":{"@type":"Person","name":"Khanh Bui"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://khanh1998.github.io/posts/postgres-advisory-locks/"},"publisher":{"@type":"Organization","name":"Khanh1998","logo":{"@type":"ImageObject","url":"https://khanh1998.github.io/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://khanh1998.github.io/ accesskey=h title="Khanh1998 (Alt + H)"><img src=https://khanh1998.github.io/favicon.ico alt aria-label=logo height=32>Khanh1998</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://khanh1998.github.io/archives/ title=Archive><span>Archive</span></a></li><li><a href=https://khanh1998.github.io/tags/ title=Tags><span>Tags</span></a></li><li><a href=https://khanh1998.github.io/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://khanh1998.github.io/>Home</a>&nbsp;»&nbsp;<a href=https://khanh1998.github.io/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">Postgres Advisory Locks</h1><div class=post-meta><span title='2025-01-20 11:56:55 +0700 +07'>January 20, 2025</span>&nbsp;·&nbsp;6 min&nbsp;·&nbsp;1277 words&nbsp;·&nbsp;Khanh Bui&nbsp;|&nbsp;<a href=https://github.com/khanh1998/khanh1998.github.io/blob/main/content/posts/postgres-advisory-locks.md rel="noopener noreferrer" target=_blank>Suggest Changes</a></div></header><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><nav id=TableOfContents><ul><li><a href=#redis>Redis</a><ul><li><a href=#setnx>SETNX</a></li><li><a href=#redlock>Redlock</a></li></ul></li><li><a href=#postgres>Postgres</a><ul><li><a href=#row-level-locks>Row-Level Locks</a></li></ul></li><li><a href=#advisory-locks>Advisory Locks</a><ul><li><a href=#transaction-level-locks>Transaction-Level Locks</a></li><li><a href=#handling-non-integer-keys>Handling Non-Integer Keys</a></li><li><a href=#session-level-locks>Session-Level Locks</a></li><li><a href=#monitoring-locks>Monitoring Locks</a></li></ul></li><li><a href=#conclusion>Conclusion</a></li></ul></nav></div></details></div><div class=post-content><p>This post is part of the series <em>Postgres for Everything</em>.</p><p>Nowadays, we typically develop stateless applications, making it easier to scale them horizontally. However, locking is an essential tool to prevent race conditions in software development. In applications with multiple instances, programming language-level locks are insufficient because they only work locally within an instance. A centralized locking mechanism, valid across all instances, is required.</p><h2 id=redis>Redis<a hidden class=anchor aria-hidden=true href=#redis>#</a></h2><h3 id=setnx>SETNX<a hidden class=anchor aria-hidden=true href=#setnx>#</a></h3><p>You can use <a href=https://redis.io/docs/latest/commands/setnx/><code>SETNX</code></a> to implement a simple lock. <code>SETNX</code> sets a value for a key only if the key does not already exist.</p><p>The key acts as the lock. Initially, it does not exist, so the fastest client can acquire it by setting a value. Other clients must wait until the key no longer exists to acquire the lock. Once the job is complete, the client releases the lock by deleting the key, giving other clients a chance to acquire it.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-0-1><a class=lnlinks href=#hl-0-1>1</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-plaintext data-lang=plaintext><span class=line><span class=cl>SETNX key value
</span></span></code></pre></td></tr></table></div></div><p><code>SETNX</code> does not allow setting an expiration time atomically when the key is created. Adding an expiration time is crucial to mitigate deadlocks and prevent crashed clients from holding locks indefinitely. You can achieve this using <a href=https://redis.io/docs/latest/commands/set/><code>SET</code></a>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-1-1><a class=lnlinks href=#hl-1-1>1</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-plaintext data-lang=plaintext><span class=line><span class=cl>SET key value NX EX 10
</span></span></code></pre></td></tr></table></div></div><p>This approach works well when your Redis deployment consists of a single master node. However, issues arise in a master-replica setup. If the master crashes before a key is replicated to its replicas, the promoted replica might allow a new client to <code>SETNX</code> on the same key, resulting in two clients holding the same lock.</p><h3 id=redlock>Redlock<a hidden class=anchor aria-hidden=true href=#redlock>#</a></h3><p>To overcome the limitations of <code>SETNX</code>, Redis offers <a href=https://redis.io/docs/latest/develop/use/patterns/distributed-locks/>Redlock</a>. Redlock works on multi-master clusters, improving the availability of the locking mechanism.</p><p>In a cluster with N nodes, Redlock requires locking N/2 + 1 nodes, tolerating up to N/2 - 1 node failures. For example, in a 5-node cluster, Redlock remains functional even if 2 nodes fail.</p><p>However, Redlock is not guaranteed to be safe in all scenarios, as discussed in <a href=http://martin.kleppmann.com/2016/02/08/how-to-do-distributed-locking.html>Martin Kleppmann’s blog</a>. Therefore, Redlock might not be suitable for critical systems like banking or financial applications.</p><h2 id=postgres>Postgres<a hidden class=anchor aria-hidden=true href=#postgres>#</a></h2><p>Redis locks are convenient but may lack the safety required for critical tasks. If you already use Postgres in your project, it can be a great choice for centralized locking.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-2-1><a class=lnlinks href=#hl-2-1>1</a>
</span><span class=lnt id=hl-2-2><a class=lnlinks href=#hl-2-2>2</a>
</span><span class=lnt id=hl-2-3><a class=lnlinks href=#hl-2-3>3</a>
</span><span class=lnt id=hl-2-4><a class=lnlinks href=#hl-2-4>4</a>
</span><span class=lnt id=hl-2-5><a class=lnlinks href=#hl-2-5>5</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>CREATE</span><span class=w> </span><span class=k>TABLE</span><span class=w> </span><span class=n>user_balance</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>name</span><span class=w> </span><span class=nb>TEXT</span><span class=w> </span><span class=k>PRIMARY</span><span class=w> </span><span class=k>KEY</span><span class=p>,</span><span class=w>       </span><span class=c1>-- Name of the user, serves as the primary key
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=n>balance</span><span class=w> </span><span class=nb>NUMERIC</span><span class=p>(</span><span class=mi>15</span><span class=p>,</span><span class=w> </span><span class=mi>2</span><span class=p>)</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=k>NULL</span><span class=w> </span><span class=k>DEFAULT</span><span class=w> </span><span class=mi>0</span><span class=p>.</span><span class=mi>00</span><span class=w> </span><span class=c1>-- Balance with two decimal places
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>INSERT</span><span class=w> </span><span class=k>INTO</span><span class=w> </span><span class=n>user_balance</span><span class=w> </span><span class=p>(</span><span class=n>name</span><span class=p>,</span><span class=w> </span><span class=n>balance</span><span class=p>)</span><span class=w> </span><span class=k>VALUES</span><span class=w> </span><span class=p>(</span><span class=s1>&#39;Alice&#39;</span><span class=p>,</span><span class=w> </span><span class=mi>100</span><span class=p>),</span><span class=w> </span><span class=p>(</span><span class=s1>&#39;Bob&#39;</span><span class=p>,</span><span class=w> </span><span class=mi>200</span><span class=p>);</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h3 id=row-level-locks>Row-Level Locks<a hidden class=anchor aria-hidden=true href=#row-level-locks>#</a></h3><p>Using the <code>SELECT ... FOR UPDATE</code> syntax, you can acquire an exclusive lock on rows. These locks are automatically released at the end of the transaction. This mechanism is often combined with transactions for atomic updates.</p><p>For more details, see <a href=https://www.postgresql.org/docs/current/explicit-locking.html#LOCKING-ROWS>PostgreSQL Row-Level Locks</a>.</p><h4 id=demonstration>Demonstration<a hidden class=anchor aria-hidden=true href=#demonstration>#</a></h4><table><thead><tr><th>Time</th><th>Transaction 1</th><th>Transaction 2</th></tr></thead><tbody><tr><td>1.0</td><td></td><td><code>BEGIN;</code></td></tr><tr><td>2.0</td><td><code>BEGIN;</code></td><td></td></tr><tr><td>3.0</td><td><code>SELECT balance FROM user_balance WHERE name = 'Alice' FOR UPDATE;</code></td><td></td></tr><tr><td>3.1</td><td>Alice’s balance = 100</td><td></td></tr><tr><td>4.0</td><td></td><td><code>SELECT balance FROM user_balance WHERE name = 'Alice' FOR UPDATE;</code></td></tr><tr><td>4.1</td><td></td><td>Blocked (Alice’s row is locked by TX1)</td></tr><tr><td>5.0</td><td><code>SELECT balance FROM user_balance WHERE name = 'Bob' FOR UPDATE;</code></td><td></td></tr><tr><td>5.1</td><td>Bob’s balance = 200</td><td></td></tr><tr><td>6.0</td><td><code>UPDATE user_balance SET balance = balance - 100 WHERE name = 'Alice';</code></td><td></td></tr><tr><td>7.0</td><td><code>UPDATE user_balance SET balance = balance + 100 WHERE name = 'Bob';</code></td><td></td></tr><tr><td>8.0</td><td><code>COMMIT;</code></td><td></td></tr><tr><td>9.0</td><td></td><td>Alice’s balance = 0</td></tr><tr><td>10.0</td><td></td><td>Continue</td></tr></tbody></table><h4 id=deadlock-example>Deadlock Example<a hidden class=anchor aria-hidden=true href=#deadlock-example>#</a></h4><p>Deadlocks can occur when transactions acquire locks in an inconsistent order. For instance:</p><table><thead><tr><th>Time</th><th>Transaction 1</th><th>Transaction 2</th></tr></thead><tbody><tr><td>1.0</td><td></td><td><code>BEGIN;</code></td></tr><tr><td>2.0</td><td><code>BEGIN;</code></td><td></td></tr><tr><td>3.0</td><td><code>SELECT balance FROM user_balance WHERE name = 'Alice' FOR UPDATE;</code></td><td></td></tr><tr><td>4.0</td><td></td><td><code>SELECT balance FROM user_balance WHERE name = 'Bob' FOR UPDATE;</code></td></tr><tr><td>5.0</td><td><code>SELECT balance FROM user_balance WHERE name = 'Bob' FOR UPDATE;</code></td><td>Blocked</td></tr><tr><td>6.0</td><td></td><td><code>SELECT balance FROM user_balance WHERE name = 'Alice' FOR UPDATE;</code></td></tr><tr><td>7.0</td><td>Deadlock</td><td>Deadlock</td></tr></tbody></table><p>To avoid deadlocks, acquire locks in a deterministic order (e.g., by ascending username).</p><h4 id=optimistic-locking>Optimistic Locking<a hidden class=anchor aria-hidden=true href=#optimistic-locking>#</a></h4><p>Optimistic locking assumes no concurrent modifications. It checks data integrity at the end of the transaction, rejecting changes if data has been altered. This approach is implemented using a <code>version</code> column, incremented on updates.</p><h5 id=successful-scenario>Successful Scenario<a hidden class=anchor aria-hidden=true href=#successful-scenario>#</a></h5><table><thead><tr><th>Time</th><th>Transaction 1</th><th>Transaction 2</th></tr></thead><tbody><tr><td>1.0</td><td></td><td><code>BEGIN;</code></td></tr><tr><td>2.0</td><td><code>BEGIN;</code></td><td></td></tr><tr><td>3.0</td><td><code>SELECT balance, version FROM user_balance WHERE name = 'Alice';</code></td><td></td></tr><tr><td>5.0</td><td><code>UPDATE user_balance SET balance = balance - 100, version = version + 1 WHERE name = 'Alice' AND version = 0;</code></td><td></td></tr><tr><td>7.0</td><td><code>COMMIT;</code></td><td></td></tr></tbody></table><h5 id=failure-scenario>Failure Scenario<a hidden class=anchor aria-hidden=true href=#failure-scenario>#</a></h5><table><thead><tr><th>Time</th><th>Transaction 1</th><th>Transaction 2</th></tr></thead><tbody><tr><td>1.0</td><td></td><td><code>BEGIN;</code></td></tr><tr><td>5.0</td><td><code>UPDATE user_balance SET balance = balance - 100, version = version + 1 WHERE name = 'Alice' AND version = 0;</code></td><td></td></tr><tr><td>6.0</td><td></td><td><code>UPDATE user_balance SET balance = 100, version = version + 1 WHERE name = 'Bob';</code></td></tr><tr><td>7.0</td><td>Update failed (version mismatch)</td><td></td></tr><tr><td>8.0</td><td><code>ROLLBACK;</code></td><td></td></tr></tbody></table><p>Optimistic locking can also be implemented without a <code>version</code> column by validating data directly in the <code>UPDATE</code> query:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-3-1><a class=lnlinks href=#hl-3-1>1</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>UPDATE</span><span class=w> </span><span class=n>user_balance</span><span class=w> </span><span class=k>SET</span><span class=w> </span><span class=n>name</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;Alice Watson&#39;</span><span class=w> </span><span class=k>WHERE</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>123</span><span class=w> </span><span class=k>AND</span><span class=w> </span><span class=n>name</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;Alice&#39;</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h2 id=advisory-locks>Advisory Locks<a hidden class=anchor aria-hidden=true href=#advisory-locks>#</a></h2><p>Row-level locks in PostgreSQL are useful, but what if the resource you need to lock doesn’t correspond to a database row? PostgreSQL provides an alternative: <a href=https://www.postgresql.org/docs/current/explicit-locking.html#ADVISORY-LOCKS>advisory locks</a>. These locks are application-defined and can operate independently of the database schema. Advisory locks can be acquired at two levels: transaction and session.</p><h3 id=transaction-level-locks>Transaction-Level Locks<a hidden class=anchor aria-hidden=true href=#transaction-level-locks>#</a></h3><p><strong>Exclusive Locks:</strong><br>You can acquire an exclusive lock at the transaction level using the <code>pg_advisory_xact_lock</code> function. This is a blocking function, meaning that if another transaction already holds the lock, the current transaction will wait until the lock becomes available:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-4-1><a class=lnlinks href=#hl-4-1>1</a>
</span><span class=lnt id=hl-4-2><a class=lnlinks href=#hl-4-2>2</a>
</span><span class=lnt id=hl-4-3><a class=lnlinks href=#hl-4-3>3</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>BEGIN</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>SELECT</span><span class=w> </span><span class=n>pg_advisory_xact_lock</span><span class=p>(</span><span class=mi>123</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>COMMIT</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>For a non-blocking version, use <code>pg_try_advisory_xact_lock</code>. It returns <code>TRUE</code> if the lock is acquired and <code>FALSE</code> otherwise.</p><p><strong>Shared Locks:</strong><br>The <code>pg_advisory_xact_lock</code> function provides exclusive locks, allowing only one transaction to hold the lock at a time. For shared access, use <code>pg_advisory_xact_lock_shared</code>. This allows multiple transactions to hold the lock simultaneously, making it suitable for read-only tasks. However, while shared locks are held, no exclusive lock can be acquired on the same key.</p><table><thead><tr><th>Time</th><th>Transaction 1</th><th>Transaction 2</th></tr></thead><tbody><tr><td>1</td><td><code>BEGIN;</code></td><td></td></tr><tr><td>2</td><td></td><td><code>BEGIN;</code></td></tr><tr><td>3</td><td>Acquire shared lock: <code>select pg_advisory_xact_lock_shared(123);</code></td><td></td></tr><tr><td>4</td><td></td><td>Try to acquire exclusive lock: <code>select pg_advisory_xact_lock(123);</code></td></tr><tr><td>4.1</td><td></td><td>Get blocked</td></tr><tr><td>5</td><td><code>commit;</code>: shared lock released</td><td>Exclusive lock acquired after release</td></tr></tbody></table><p><strong>Lock Release:</strong><br>All transaction-level advisory locks are automatically released when the transaction ends, whether through <code>COMMIT</code> or <code>ROLLBACK</code>.</p><p><strong>Locking Costs:</strong><br>Advisory locks are lightweight and impose less overhead compared to row-level locks. For example:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-5-1><a class=lnlinks href=#hl-5-1> 1</a>
</span><span class=lnt id=hl-5-2><a class=lnlinks href=#hl-5-2> 2</a>
</span><span class=lnt id=hl-5-3><a class=lnlinks href=#hl-5-3> 3</a>
</span><span class=lnt id=hl-5-4><a class=lnlinks href=#hl-5-4> 4</a>
</span><span class=lnt id=hl-5-5><a class=lnlinks href=#hl-5-5> 5</a>
</span><span class=lnt id=hl-5-6><a class=lnlinks href=#hl-5-6> 6</a>
</span><span class=lnt id=hl-5-7><a class=lnlinks href=#hl-5-7> 7</a>
</span><span class=lnt id=hl-5-8><a class=lnlinks href=#hl-5-8> 8</a>
</span><span class=lnt id=hl-5-9><a class=lnlinks href=#hl-5-9> 9</a>
</span><span class=lnt id=hl-5-10><a class=lnlinks href=#hl-5-10>10</a>
</span><span class=lnt id=hl-5-11><a class=lnlinks href=#hl-5-11>11</a>
</span><span class=lnt id=hl-5-12><a class=lnlinks href=#hl-5-12>12</a>
</span><span class=lnt id=hl-5-13><a class=lnlinks href=#hl-5-13>13</a>
</span><span class=lnt id=hl-5-14><a class=lnlinks href=#hl-5-14>14</a>
</span><span class=lnt id=hl-5-15><a class=lnlinks href=#hl-5-15>15</a>
</span><span class=lnt id=hl-5-16><a class=lnlinks href=#hl-5-16>16</a>
</span><span class=lnt id=hl-5-17><a class=lnlinks href=#hl-5-17>17</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=n>postgres</span><span class=o>=#</span><span class=w> </span><span class=k>explain</span><span class=w> </span><span class=k>analyze</span><span class=w> </span><span class=k>select</span><span class=w> </span><span class=n>pg_advisory_lock</span><span class=p>(</span><span class=mi>123</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                     </span><span class=n>QUERY</span><span class=w> </span><span class=n>PLAN</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>------------------------------------------------------------------------------------
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w> </span><span class=k>Result</span><span class=w>  </span><span class=p>(</span><span class=n>cost</span><span class=o>=</span><span class=mi>0</span><span class=p>.</span><span class=mi>00</span><span class=p>..</span><span class=mi>0</span><span class=p>.</span><span class=mi>01</span><span class=w> </span><span class=k>rows</span><span class=o>=</span><span class=mi>1</span><span class=w> </span><span class=n>width</span><span class=o>=</span><span class=mi>4</span><span class=p>)</span><span class=w> </span><span class=p>(</span><span class=n>actual</span><span class=w> </span><span class=n>time</span><span class=o>=</span><span class=mi>0</span><span class=p>.</span><span class=mi>010</span><span class=p>..</span><span class=mi>0</span><span class=p>.</span><span class=mi>012</span><span class=w> </span><span class=k>rows</span><span class=o>=</span><span class=mi>1</span><span class=w> </span><span class=n>loops</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=n>Planning</span><span class=w> </span><span class=n>Time</span><span class=p>:</span><span class=w> </span><span class=mi>0</span><span class=p>.</span><span class=mi>111</span><span class=w> </span><span class=n>ms</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=n>Execution</span><span class=w> </span><span class=n>Time</span><span class=p>:</span><span class=w> </span><span class=mi>0</span><span class=p>.</span><span class=mi>046</span><span class=w> </span><span class=n>ms</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>(</span><span class=mi>3</span><span class=w> </span><span class=k>rows</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>postgres</span><span class=o>=#</span><span class=w> </span><span class=k>explain</span><span class=w> </span><span class=k>analyze</span><span class=w> </span><span class=k>select</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>from</span><span class=w> </span><span class=n>user_balance</span><span class=w> </span><span class=k>where</span><span class=w> </span><span class=n>name</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;Alice&#39;</span><span class=w> </span><span class=k>for</span><span class=w> </span><span class=k>update</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                                              </span><span class=n>QUERY</span><span class=w> </span><span class=n>PLAN</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>---------------------------------------------------------------------------------------------------------------------------------------
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w> </span><span class=n>LockRows</span><span class=w>  </span><span class=p>(</span><span class=n>cost</span><span class=o>=</span><span class=mi>0</span><span class=p>.</span><span class=mi>15</span><span class=p>..</span><span class=mi>8</span><span class=p>.</span><span class=mi>18</span><span class=w> </span><span class=k>rows</span><span class=o>=</span><span class=mi>1</span><span class=w> </span><span class=n>width</span><span class=o>=</span><span class=mi>60</span><span class=p>)</span><span class=w> </span><span class=p>(</span><span class=n>actual</span><span class=w> </span><span class=n>time</span><span class=o>=</span><span class=mi>0</span><span class=p>.</span><span class=mi>201</span><span class=p>..</span><span class=mi>0</span><span class=p>.</span><span class=mi>207</span><span class=w> </span><span class=k>rows</span><span class=o>=</span><span class=mi>1</span><span class=w> </span><span class=n>loops</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=o>-&gt;</span><span class=w>  </span><span class=k>Index</span><span class=w> </span><span class=n>Scan</span><span class=w> </span><span class=k>using</span><span class=w> </span><span class=n>user_balance_pkey</span><span class=w> </span><span class=k>on</span><span class=w> </span><span class=n>user_balance</span><span class=w>  </span><span class=p>(</span><span class=n>cost</span><span class=o>=</span><span class=mi>0</span><span class=p>.</span><span class=mi>15</span><span class=p>..</span><span class=mi>8</span><span class=p>.</span><span class=mi>17</span><span class=w> </span><span class=k>rows</span><span class=o>=</span><span class=mi>1</span><span class=w> </span><span class=n>width</span><span class=o>=</span><span class=mi>60</span><span class=p>)</span><span class=w> </span><span class=p>(</span><span class=n>actual</span><span class=w> </span><span class=n>time</span><span class=o>=</span><span class=mi>0</span><span class=p>.</span><span class=mi>061</span><span class=p>..</span><span class=mi>0</span><span class=p>.</span><span class=mi>066</span><span class=w> </span><span class=k>rows</span><span class=o>=</span><span class=mi>1</span><span class=w> </span><span class=n>loops</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=k>Index</span><span class=w> </span><span class=n>Cond</span><span class=p>:</span><span class=w> </span><span class=p>(</span><span class=n>name</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;Alice&#39;</span><span class=p>::</span><span class=nb>text</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=n>Planning</span><span class=w> </span><span class=n>Time</span><span class=p>:</span><span class=w> </span><span class=mi>0</span><span class=p>.</span><span class=mi>218</span><span class=w> </span><span class=n>ms</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=n>Execution</span><span class=w> </span><span class=n>Time</span><span class=p>:</span><span class=w> </span><span class=mi>0</span><span class=p>.</span><span class=mi>258</span><span class=w> </span><span class=n>ms</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>(</span><span class=mi>5</span><span class=w> </span><span class=k>rows</span><span class=p>)</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h3 id=handling-non-integer-keys>Handling Non-Integer Keys<a hidden class=anchor aria-hidden=true href=#handling-non-integer-keys>#</a></h3><p>Advisory locks only accept integer keys. To lock on a string key, hash it into an integer first:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-6-1><a class=lnlinks href=#hl-6-1>1</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>SELECT</span><span class=w> </span><span class=n>pg_advisory_xact_lock</span><span class=p>(</span><span class=n>hashtext</span><span class=p>(</span><span class=s1>&#39;my_unique_lock&#39;</span><span class=p>));</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h3 id=session-level-locks>Session-Level Locks<a hidden class=anchor aria-hidden=true href=#session-level-locks>#</a></h3><p>Session-level locks persist across multiple transactions until explicitly released or the session ends. They are less commonly used but can be explored further in the <a href=https://www.postgresql.org/docs/current/functions-admin.html#FUNCTIONS-ADVISORY-LOCKS>PostgreSQL documentation</a>.</p><h3 id=monitoring-locks>Monitoring Locks<a hidden class=anchor aria-hidden=true href=#monitoring-locks>#</a></h3><p>To view active advisory locks, query the <code>pg_locks</code> system catalog:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-7-1><a class=lnlinks href=#hl-7-1>1</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>SELECT</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=n>pg_locks</span><span class=w> </span><span class=k>WHERE</span><span class=w> </span><span class=n>locktype</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;advisory&#39;</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h2 id=conclusion>Conclusion<a hidden class=anchor aria-hidden=true href=#conclusion>#</a></h2><p>If Postgres is part of your tech stack, it’s an excellent choice for centralized locking, offering robust transaction management. Redis <code>SETNX</code> is fast but limited to single-node deployments. Redis Redlock provides high availability but lacks safety for critical applications. For highly available and safe distributed locking, consider Etcd, Consul, or ZooKeeper.</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://khanh1998.github.io/tags/db/>Db</a></li><li><a href=https://khanh1998.github.io/tags/postgres-for-everything/>Postgres-for-Everything</a></li></ul><nav class=paginav><a class=prev href=https://khanh1998.github.io/posts/envelop-encryption/><span class=title>« Prev</span><br><span>Envelop Encryption</span>
</a><a class=next href=https://khanh1998.github.io/posts/postgres-collation/><span class=title>Next »</span><br><span>Postgres Collation</span></a></nav><ul class=share-buttons><li><a target=_blank rel="noopener noreferrer" aria-label="share Postgres Advisory Locks on x" href="https://x.com/intent/tweet/?text=Postgres%20Advisory%20Locks&amp;url=https%3a%2f%2fkhanh1998.github.io%2fposts%2fpostgres-advisory-locks%2f&amp;hashtags=db%2cpostgres-for-everything"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446C483.971.0 512 28.03 512 62.554zM269.951 190.75 182.567 75.216H56L207.216 272.95 63.9 436.783h61.366L235.9 310.383l96.667 126.4H456L298.367 228.367l134-153.151H371.033zM127.633 110h36.468l219.38 290.065H349.5z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Postgres Advisory Locks on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fkhanh1998.github.io%2fposts%2fpostgres-advisory-locks%2f&amp;title=Postgres%20Advisory%20Locks&amp;summary=Postgres%20Advisory%20Locks&amp;source=https%3a%2f%2fkhanh1998.github.io%2fposts%2fpostgres-advisory-locks%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Postgres Advisory Locks on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fkhanh1998.github.io%2fposts%2fpostgres-advisory-locks%2f&title=Postgres%20Advisory%20Locks"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Postgres Advisory Locks on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fkhanh1998.github.io%2fposts%2fpostgres-advisory-locks%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Postgres Advisory Locks on whatsapp" href="https://api.whatsapp.com/send?text=Postgres%20Advisory%20Locks%20-%20https%3a%2f%2fkhanh1998.github.io%2fposts%2fpostgres-advisory-locks%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Postgres Advisory Locks on telegram" href="https://telegram.me/share/url?text=Postgres%20Advisory%20Locks&amp;url=https%3a%2f%2fkhanh1998.github.io%2fposts%2fpostgres-advisory-locks%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentcolor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Postgres Advisory Locks on ycombinator" href="https://news.ycombinator.com/submitlink?t=Postgres%20Advisory%20Locks&u=https%3a%2f%2fkhanh1998.github.io%2fposts%2fpostgres-advisory-locks%2f"><svg width="30" height="30" viewBox="0 0 512 512" fill="currentcolor" xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape"><path d="M449.446.0C483.971.0 512 28.03 512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446zM183.8767 87.9921h-62.034L230.6673 292.4508V424.0079h50.6655V292.4508L390.1575 87.9921H328.1233L256 238.2489z"/></svg></a></li></ul></footer><div id=disqus_thread></div><script>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//khanh1998.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></article></main><footer class=footer><span>&copy; 2025 <a href=https://khanh1998.github.io/>Khanh1998</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>